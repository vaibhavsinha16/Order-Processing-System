<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - Order Processing System</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            background: #f1f3f6;
        }
        header {
            background: #2874f0;
            color: #fff;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header h1 {
            margin: 0;
            font-size: 2rem;
            letter-spacing: 1px;
        }
        .cart-btn {
            background: #fff;
            color: #2874f0;
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1.2rem;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
        }
        .cart-btn span {
            margin-left: 0.5rem;
            background: #ff6161;
            color: #fff;
            border-radius: 50%;
            padding: 0.2rem 0.6rem;
            font-size: 0.9rem;
        }
        .main {
            display: flex;
            max-width: 1200px;
            margin: 2rem auto;
            gap: 2rem;
        }
        .products {
            flex: 3;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 2rem;
        }
        .product {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: box-shadow 0.2s;
        }
        .product:hover {
            box-shadow: 0 4px 16px #0002;
        }
        .product img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin-bottom: 1rem;
        }
        .product-name {
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .product-price {
            color: #388e3c;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        .add-btn {
            background: #ff9f00;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .add-btn:hover {
            background: #fb641b;
        }
        .cart {
            flex: 1;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
            padding: 1.5rem 1rem;
            min-width: 260px;
            max-width: 320px;
            position: sticky;
            top: 2rem;
            height: fit-content;
        }
        .cart h2 {
            margin-top: 0;
            font-size: 1.2rem;
            color: #2874f0;
        }
        .cart-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }
        .cart-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.7rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        .cart-list .item-name {
            flex: 2;
        }
        .cart-list .item-qty {
            flex: 1;
            text-align: center;
        }
        .cart-list .item-price {
            flex: 1;
            text-align: right;
        }
        .cart-list .remove-btn {
            background: none;
            border: none;
            color: #ff6161;
            font-size: 1.1rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        .cart-total {
            font-weight: bold;
            text-align: right;
            margin-top: 1rem;
            font-size: 1.1rem;
        }
        .checkout-btn {
            width: 100%;
            background: #2874f0;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.7rem 0;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .checkout-btn:hover {
            background: #0059b2;
        }
        @media (max-width: 900px) {
            .main { flex-direction: column; }
            .cart { max-width: 100%; min-width: 0; position: static; }
        }
    </style>
</head>
<body>
<header>
    <div style="display: flex; align-items: center; gap: 2rem;">
        <h1>Shop</h1>
        <button id="my-orders-btn" onclick="window.location.href='/my-orders.html'" style="display: none;">My Orders</button>
    </div>
    <div id="auth-buttons"></div>
</header>
<div class="main">
    <div class="products" id="products">
        <!-- Product cards will be injected here -->
    </div>
    <aside class="cart">
        <h2>Your Cart</h2>
        <ul class="cart-list" id="cart-list"></ul>
        <div class="cart-total" id="cart-total">Total: $0.00</div>
        <button class="checkout-btn" id="checkout-btn" disabled>Checkout</button>
        <div id="address-section"></div>
    </aside>
</div>
<script>
// Global variables
let products = [];
let addresses = [];
let selectedAddressId = null;
let currentUser = null;
let cart = null; // Will store cart data from backend

// Initialize the application
async function initializeApp() {
    await fetchProducts();
    await fetchUserInfo();
    renderAuthButtons();
    
    if (localStorage.getItem('token')) {
        await fetchAddresses();
        await fetchCart(); // Fetch cart from backend
    }
    
    renderCart();
}

async function fetchProducts() {
    try {
        const res = await fetch('/products');
        if (res.ok) {
            products = await res.json();
            renderProducts();
        }
    } catch (error) {
        console.error('Failed to fetch products:', error);
    }
}

async function fetchUserInfo() {
    if (localStorage.getItem('token')) {
        try {
            const res = await fetch('/auth/profile', {
                headers: { 'X-Auth-Token': localStorage.getItem('token') }
            });
            if (res.ok) {
                currentUser = await res.json();
            }
        } catch (error) {
            console.error('Failed to fetch user info:', error);
        }
    }
}

async function fetchAddresses() {
    if (!localStorage.getItem('token')) return;
    try {
        const res = await fetch('/addresses', {
            headers: { 'X-Auth-Token': localStorage.getItem('token') }
        });
        if (res.ok) {
            addresses = await res.json();
            renderAddresses();
        }
    } catch (error) {
        console.error('Failed to fetch addresses:', error);
    }
}

async function fetchCart() {
    if (!localStorage.getItem('token')) return;
    
    try {
        const res = await fetch('/cart', {
            headers: { 'X-Auth-Token': localStorage.getItem('token') }
        });
        if (res.ok) {
            cart = await res.json();
            renderCart();
        }
    } catch (error) {
        console.error('Failed to fetch cart:', error);
    }
}

function renderAddresses() {
    const addressSection = document.getElementById('address-section');
    if (!addressSection) return;
    
    let html = '<label for="address-select">Deliver to:</label>';
    html += '<select id="address-select"></select>';
    html += '<button onclick="showAddAddress()">Add Address</button>';
    addressSection.innerHTML = html;
    
    const select = document.getElementById('address-select');
    if (addresses.length > 0) {
        select.innerHTML = addresses.map(a => `<option value="${a.id}">${a.street}, ${a.city}</option>`).join('');
        select.onchange = e => {
            selectedAddressId = Number(e.target.value);
            renderCart();
        };
        selectedAddressId = addresses[0].id;
        select.value = selectedAddressId;
    } else {
        select.innerHTML = '<option value="">No addresses</option>';
        selectedAddressId = null;
    }
    renderCart();
}

function showAddAddress() {
    if (!localStorage.getItem('token')) {
        alert('Please login to add addresses.');
        window.location.href = '/login.html';
        return;
    }
    
    const form = document.createElement('form');
    form.style.cssText = 'margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;';
    form.innerHTML = `
        <h4>Add New Address</h4>
        <input name="street" placeholder="Street" required style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem;" />
        <input name="city" placeholder="City" required style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem;" />
        <input name="state" placeholder="State" required style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem;" />
        <input name="zip" placeholder="ZIP" required style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem;" />
        <input name="country" placeholder="Country" required style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem;" />
        <button type="submit" style="background: #2874f0; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Save Address</button>
        <button type="button" onclick="this.parentElement.remove()" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Cancel</button>
    `;
    
    form.onsubmit = async e => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form));
        try {
            const res = await fetch('/addresses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Auth-Token': localStorage.getItem('token') },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                form.remove();
                await fetchAddresses();
            } else {
                alert('Failed to add address');
            }
        } catch (error) {
            alert('Failed to add address');
        }
    };
    
    document.querySelector('.cart').prepend(form);
}

function renderProducts() {
    const productsDiv = document.getElementById('products');
    productsDiv.innerHTML = '';
    products.forEach(product => {
        const div = document.createElement('div');
        div.className = 'product';
        div.innerHTML = `
            <img src="${product.imageUrl}" alt="${product.name}">
            <div class="product-name">${product.name}</div>
            <div class="product-price">$${product.price.toFixed(2)}</div>
            <button class="add-btn" onclick="addToCart(${product.id})">Add to Cart</button>
        `;
        productsDiv.appendChild(div);
    });
}

async function addToCart(productId) {
    if (!localStorage.getItem('token')) {
        alert('Please login to add items to cart.');
        window.location.href = '/login.html';
        return;
    }
    
    try {
        const res = await fetch(`/cart/add?productId=${productId}&quantity=1`, {
            method: 'POST',
            headers: { 'X-Auth-Token': localStorage.getItem('token') }
        });
        
        if (res.ok) {
            cart = await res.json();
            renderCart();
        } else {
            alert('Failed to add item to cart.');
        }
    } catch (error) {
        console.error('Error adding to cart:', error);
        alert('Error adding item to cart.');
    }
}

async function removeFromCart(productId) {
    if (!localStorage.getItem('token')) {
        alert('Please login to manage cart.');
        return;
    }
    
    try {
        const res = await fetch(`/cart/remove?productId=${productId}`, {
            method: 'DELETE',
            headers: { 'X-Auth-Token': localStorage.getItem('token') }
        });
        
        if (res.ok) {
            cart = await res.json();
            renderCart();
        } else {
            alert('Failed to remove item from cart.');
        }
    } catch (error) {
        console.error('Error removing from cart:', error);
        alert('Error removing item from cart.');
    }
}

function renderCart() {
    const cartList = document.getElementById('cart-list');
    const cartItems = cart ? cart.items : [];
    cartList.innerHTML = '';
    
    cartItems.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span class="item-name">${item.productName}</span>
            <span class="item-qty">x${item.quantity}</span>
            <span class="item-price">$${item.subtotal.toFixed(2)}</span>
            <button class="remove-btn" onclick="removeFromCart(${item.productId})">&times;</button>
        `;
        cartList.appendChild(li);
    });
    
    // Use server-calculated total
    const total = cart ? cart.total : 0;
    document.getElementById('cart-total').textContent = `Total: $${total.toFixed(2)}`;
    
    // Update checkout button state
    const checkoutBtn = document.getElementById('checkout-btn');
    const isLoggedIn = localStorage.getItem('token');
    const hasItems = cartItems.length > 0;
    const hasAddress = selectedAddressId && addresses.length > 0;
    
    if (!isLoggedIn) {
        checkoutBtn.textContent = 'Login to Checkout';
        checkoutBtn.disabled = false; // Always enabled for login
        checkoutBtn.onclick = () => {
            console.log('Redirecting to login page...');
            window.location.href = '/login.html';
        };
    } else if (!hasItems) {
        checkoutBtn.textContent = 'Add Items to Cart';
        checkoutBtn.disabled = true;
        checkoutBtn.onclick = null;
    } else if (!hasAddress) {
        checkoutBtn.textContent = 'Add Address to Checkout';
        checkoutBtn.disabled = false;
        checkoutBtn.onclick = showAddAddress;
    } else {
        checkoutBtn.textContent = 'Checkout';
        checkoutBtn.disabled = false;
        checkoutBtn.onclick = checkout;
    }
}

function checkout() {
    if (!localStorage.getItem('token')) {
        alert('Please login to place an order.');
        window.location.href = '/login.html';
        return;
    }
    
    if (!selectedAddressId) {
        alert('Please select or add an address.');
        return;
    }
    
    if (!cart || cart.items.length === 0) {
        alert('Your cart is empty.');
        return;
    }
    
    const items = cart.items.map(item => ({ productId: item.productId, quantity: item.quantity }));
    
    fetch('/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Auth-Token': localStorage.getItem('token') },
        body: JSON.stringify({ items, addressId: selectedAddressId })
    })
    .then(async res => {
        if (res.ok) {
            alert('Order placed successfully!');
            // Clear cart on the backend
            await fetch('/cart/clear', {
                method: 'DELETE',
                headers: { 'X-Auth-Token': localStorage.getItem('token') }
            });
            // Refresh cart data
            await fetchCart();
        } else {
            res.text().then(msg => alert('Order failed: ' + msg));
        }
    })
    .catch(() => alert('Order failed: Network error'));
}

function renderAuthButtons() {
    const div = document.getElementById('auth-buttons');
    if (localStorage.getItem('token')) {
        const userName = currentUser ? currentUser.username : 'User';
        div.innerHTML = `
            <span style="margin-right: 1rem;">Welcome, ${userName}!</span>
            <button onclick="logout()">Logout</button>
        `;
        document.getElementById('my-orders-btn').style.display = 'inline-block';
    } else {
        div.innerHTML = '<button onclick="window.location.href=\'/login.html\'">Login / Register</button>';
        document.getElementById('my-orders-btn').style.display = 'none';
    }
}

function logout() {
    localStorage.removeItem('token');
    currentUser = null;
    selectedAddressId = null;
    addresses = [];
    cart = null; // Clear cart on logout
    window.location.reload();
}

// Start the application
initializeApp();
</script>
</body>
</html> 